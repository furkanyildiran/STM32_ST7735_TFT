#include "st7735.h"

static inline void resetHW(void);
static void send_command(uint8_t cmd);
static void send_byte(uint8_t byte);
static void send_data(uint8_t buff[], uint16_t size);
static void send_pixelVal(Colors_t color);
static SPI_HandleTypeDef *spi_ptr;

typedef union{
	struct{
		uint8_t :8;
		uint8_t start;
		uint8_t :8;
		uint8_t end;
	};
	uint8_t reg_val[4];
}Window_t;

struct{
	uint8_t height;
	uint8_t width;
	uint8_t orienation;
}Screen_t={.height=ST7735_TFT_HEIGHT, .width = ST7735_TFT_WIDTH, .orienation = VERTICAL};

union{
	struct{
		uint8_t:1;
		uint8_t:1;
		uint8_t MH:1;
		uint8_t RGB:1;
		uint8_t ML:1;
		uint8_t MV:1;
		uint8_t MX:1;
		uint8_t MY:1;
	}MADCTL_val_t;
	uint8_t reg_val;
}MADCTL_val_u={.reg_val=0};

static Window_t x={.start=0, .end=ST7735_TFT_DEFAULT_XMAX_ADDR}, y={.start=0, .end=ST7735_TFT_DEFAULT_YMAX_ADDR};

static uint8_t arr[96][8]={
		{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},//space
		{0x18,0x18,0x18,0x18,0x18,0x18,0x00,0x18},//!
		{0x36,0x36,0x36,0x00,0x00,0x00,0x00,0x00},//"
		{0x00,0x28,0x28,0xFE,0x28,0xFE,0x28,0x28},//#
		{0x10,0x38,0x64,0x30,0x18,0x4C,0x38,0x10},//$
		{0xC2,0xC6,0x0C,0x18,0x30,0x60,0xC6,0x86},//%
		{0x38,0x44,0x44,0x24,0x58,0x48,0x44,0x3A},//&
		{0x20,0x30,0x18,0x0C,0x04,0x00,0x00,0x00},//`
		{0x0C,0x18,0x30,0x20,0x20,0x30,0x18,0x0C},//(
		{0x30,0x18,0x0C,0x04,0x04,0x0C,0x18,0x30},//)
		{0x00,0x54,0x54,0x54,0x38,0x54,0x54,0x54},//*
		{0x00,0x18,0x18,0x7E,0x7E,0x18,0x18,0x00},//+
		{0x00,0x00,0x00,0x00,0x04,0x0C,0x18,0x30},//,
		{0x00,0x00,0x00,0x7E,0x7E,0x00,0x00,0x00},//-
		{0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18},//.
		{0x02,0x06,0x0C,0x18,0x30,0x60,0xC0,0x80},///
		{0x3C,0x66,0x4A,0x4A,0x52,0x52,0x66,0x3C},//0
		{0x08,0x18,0x38,0x18,0x18,0x18,0x18,0x3C},//1
		{0x1C,0x3E,0x66,0x0C,0x18,0x30,0x7E,0x7E},//2
		{0x7C,0x3E,0x06,0x3E,0x3E,0x06,0x3E,0x7C},//3
		{0x0C,0x1C,0x3C,0x6C,0xCC,0xFE,0xFC,0x0C},//4
		{0x7E,0x7E,0x60,0x7C,0x0E,0x06,0x4E,0x7C},//5
		{0x1E,0x30,0x20,0x7C,0x66,0x46,0x66,0x3C},//6
		{0x7E,0x7E,0x06,0x0C,0x18,0x30,0x20,0x20},//7
		{0x3C,0x66,0x66,0x3C,0x66,0x66,0x66,0x3C},//8
		{0x3C,0x66,0x66,0x3E,0x06,0x06,0x6E,0x3C},//9
		{0x00,0x00,0x00,0x18,0x18,0x00,0x18,0x18},//:
		{0x00,0x0C,0x0C,0x00,0x0C,0x18,0x30,0x20},//;
		{0x00,0x04,0x0C,0x18,0x30,0x18,0x0C,0x04},//<
		{0x00,0x00,0x7C,0x7C,0x00,0x7C,0x7C,0x00},//=
		{0x00,0x20,0x30,0x18,0x0C,0x18,0x30,0x20},//>
		{0x38,0x6C,0x4C,0x18,0x30,0x20,0x00,0x20},//?
		{0x7C,0xC6,0xBA,0xAA,0xAA,0xBA,0xCE,0x60},//@1
		{0x10,0x38,0x6C,0xC6,0xFE,0xFE,0x82,0x82},//A
		{0xF8,0xCC,0xCC,0xF8,0xFC,0xCC,0xCC,0xF8},//B
		{0x3C,0x66,0xE2,0xC0,0xC0,0xE2,0x66,0x3C},//C
		{0x7C,0x66,0x66,0x66,0x66,0x66,0x66,0x7C},//D
		{0x7E,0x60,0x60,0x7C,0x7C,0x60,0x60,0x7E},//E
		{0x7E,0x7E,0x60,0x7C,0x7C,0x60,0x60,0x60},//F
		{0x3C,0x66,0xE2,0xC0,0xCE,0xE6,0x66,0x3C},//G
		{0xC6,0xC6,0xC6,0xFE,0xFE,0xC6,0xC6,0xC6},//H
		{0x7E,0x18,0x18,0x18,0x18,0x18,0x18,0x7E},//I
		{0x3E,0x3E,0x06,0x06,0x06,0x66,0x3E,0x1C},//J
		{0xC6,0xCC,0xD8,0xF0,0xF8,0xCC,0xC6,0xC2},//K
		{0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xFE,0xFE},//L
		{0x82,0xC6,0xEE,0xFE,0xBA,0x92,0x92,0x82},//M
		{0xC2,0xE2,0xF2,0xBA,0x9E,0x8E,0x86,0x82},//N
		{0x7C,0xC6,0x82,0x82,0x82,0x82,0xC6,0x7C},//O
		{0x3C,0x66,0x66,0x66,0x7C,0x60,0x60,0x60},//P
		{0x7C,0xC6,0x82,0x82,0x92,0x8A,0xC4,0x7A},//Q
		{0x78,0xCC,0xCC,0xCC,0xF8,0xCC,0xC6,0xC2},//R
		{0x38,0x6C,0x66,0x30,0x18,0xCC,0x6C,0x38},//S
		{0x7E,0x7E,0x18,0x18,0x18,0x18,0x18,0x18},//T
		{0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xFE,0x7C},//U
		{0x82,0x82,0xC6,0xC6,0x6C,0x7C,0x38,0x10},//V
		{0xC6,0xC6,0xD6,0xD6,0xD6,0xD6,0xFE,0x7C},//W
		{0x82,0xC6,0x6C,0x38,0x38,0x6C,0xC6,0x82},//X
		{0x82,0xC6,0x6C,0x38,0x10,0x10,0x10,0x10},//Y
		{0xFE,0x06,0x0C,0x18,0x30,0x60,0xC0,0xFE},//Z
		{0x3C,0x30,0x30,0x30,0x30,0x30,0x30,0x3C},//[
		{0x80,0xC0,0x60,0x30,0x18,0x0C,0x06,0x02},//\.
		{0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C},//]
		{0x00,0x10,0x38,0x6C,0xC6,0x82,0x00,0x00},//^
		{0x00,0x00,0x00,0x00,0x00,0x00,0x7E,0x7E},//_
		{0x20,0x30,0x18,0x0C,0x04,0x00,0x00,0x00},//`
		{0x00,0x00,0x3C,0x06,0x3E,0x66,0x66,0x3E},//a
		{0x60,0x60,0x7C,0x76,0x62,0x62,0x76,0x3C},//b
		{0x00,0x00,0x3C,0x66,0x40,0x40,0x66,0x3C},//c
		{0x06,0x06,0x3E,0x6E,0x46,0x46,0x6E,0x3C},//d
		{0x00,0x00,0x3C,0x66,0x66,0x7C,0x60,0x3C},//e
		{0x00,0x3C,0x76,0x62,0xF8,0xF8,0x60,0x60},//f
		{0x00,0x3C,0x66,0x66,0x3E,0x02,0x66,0x3C},//g
		{0xC0,0xC0,0xF8,0xFC,0xCC,0xCC,0xCE,0xCE},//h
		{0x18,0x00,0x7E,0x18,0x18,0x18,0x18,0x7E},//i
		{0x00,0x0E,0x0E,0x04,0x04,0x44,0x6C,0x38},//j
		{0x60,0x60,0x66,0x6C,0x78,0x5C,0x66,0x62},//k
		{0x78,0x78,0x18,0x18,0x18,0x18,0x7E,0x7E},//l
		{0x00,0x00,0x7C,0xFE,0xD6,0xD6,0xD6,0xC6},//m
		{0x00,0x00,0x3C,0x7E,0x66,0x66,0x66,0x66},//n
		{0x00,0x00,0x3C,0x66,0x42,0x42,0x66,0x3C},//o
		{0x00,0x00,0x3C,0x66,0x66,0x7C,0x60,0x60},//p
		{0x00,0x00,0x3C,0x66,0x42,0x4A,0x64,0x3A},//q
		{0x00,0x00,0x58,0x7C,0x6C,0x64,0x60,0x60},//r
		{0x00,0x00,0x3C,0x26,0x10,0x08,0x64,0x3C},//s
		{0x00,0x20,0x70,0x70,0x20,0x24,0x3C,0x18},//t
		{0x00,0x00,0x66,0x66,0x66,0x66,0x66,0x3C},//u
		{0x00,0x00,0x82,0x82,0xC6,0x6C,0x38,0x10},//v
		{0x00,0x00,0x00,0x82,0x92,0xD6,0xD6,0x7C},//w
		{0x00,0x00,0x44,0x6C,0x38,0x38,0x6C,0x44},//x
		{0x00,0x00,0x66,0x66,0x3E,0x06,0x66,0x3C},//y
		{0x00,0x00,0x7C,0x0C,0x18,0x30,0x60,0x7C},//z
		{0x00,0x0C,0x18,0x10,0x30,0x10,0x18,0x0C},//{
		{0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30},//|
		{0x00,0x30,0x18,0x08,0x0C,0x08,0x18,0x30},//}
		{0x00,0x00,0x62,0xB2,0x9A,0x8C,0x00,0x00}//~
};

void ST7735_TFT_init(SPI_HandleTypeDef *hspi_ptr){
	spi_ptr = hspi_ptr;
	SET_PIN(CS_PORT,CS);
	SET_PIN(RST_PORT,RST);
	SET_PIN(DC_PORT,DC);
	resetHW();
	send_command(SLPOUT);
	send_command(DISPON);
	HAL_Delay(300);
	ST7735_TFT_setColorMod(BitPerPixel_16);
	ST7735_TFT_setWindow(x.start, x.end, y.start, y.end);
}

void ST7735_TFT_setXBoundary(uint8_t x_start, uint8_t x_end){
	x.start = x_start;
	x.end = x_end;
	send_command(CASET);
	RST_PIN(CS_PORT, CS);
	send_data(x.reg_val, 4);
	SET_PIN(CS_PORT, CS);
}

void ST7735_TFT_setYBoundary(uint8_t y_start, uint8_t y_end){
	y.start = y_start;
	y.end = y_end;
	send_command(RASET);
	RST_PIN(CS_PORT, CS);
	send_data(y.reg_val, 4);
	SET_PIN(CS_PORT, CS);
}

void ST7735_TFT_setWindow(uint8_t x_start, uint8_t x_end, uint8_t y_start, uint8_t y_end){
	ST7735_TFT_setXBoundary(x_start, x_end);
	ST7735_TFT_setYBoundary(y_start, y_end);
}

void ST7735_TFT_setColorMod(COLMOD_arg_t colmod){
	send_command(COLMOD);
	send_byte(colmod);
}

void ST7735_TFT_setOrientation(Orientation_t orientation){
	if(orientation == LANDSCAPE){
		MADCTL_val_u.MADCTL_val_t.MV=1;
		MADCTL_val_u.MADCTL_val_t.MX=1;
		Screen_t.orienation=LANDSCAPE;
		Screen_t.width=160;
		Screen_t.height=128;
	}else{
		MADCTL_val_u.reg_val=0;
		Screen_t.orienation=LANDSCAPE;
		Screen_t.width=128;
		Screen_t.height=160;
	}
	send_command(MADCTL);
	send_byte(MADCTL_val_u.reg_val);
}

void ST7735_TFT_Paint(uint8_t x_start, uint8_t x_end, uint8_t y_start, uint8_t y_end, Colors_t color){
	ST7735_TFT_setWindow(x_start, x_end, y_start, y_end);
	send_command(RAMWR);
		uint8_t buff[2]={(color>>8), color&0xFF};
		RST_PIN(CS_PORT, CS);
		for(uint16_t i = 0; i < ((x_end-x_start)+1)*((y_end-y_start)+1); i++){
			send_data(buff, 2);
		}
		SET_PIN(CS_PORT, CS);
}
void ST7735_TFT_fillScreen(Colors_t color){
	ST7735_TFT_setWindow(0, ST7735_TFT_DEFAULT_XMAX_ADDR, 0, ST7735_TFT_DEFAULT_YMAX_ADDR);
	send_command(RAMWR);
	uint8_t buff[2]={(color>>8), color&0xFF};
	RST_PIN(CS_PORT, CS);
	for(uint16_t i = 0; i < ST7735_TFT_PIXEL_NUM; i++){
		send_data(buff, 2);
	}
	SET_PIN(CS_PORT, CS);
}

void ST7735_TFT_writeChar(char ch, uint8_t x_addr, uint8_t y_addr, Colors_t charColor, Colors_t backgroundColor){
	ST7735_TFT_setWindow(x_addr, x_addr+7, y_addr, y_addr+7);
	send_command(RAMWR);
	RST_PIN(CS_PORT, CS);
	for(uint8_t i = 0; i < 8; i++){
		for(int8_t j = 7; j >= 0; j--){
			uint16_t val = arr[(uint8_t)(ch-0x20)][i]>>j;
			if((val&1)==1)send_pixelVal(charColor);
			else send_pixelVal(backgroundColor);
		}
	}
	SET_PIN(CS_PORT, CS);
}

void ST7735_TFT_writeString(char text[], uint8_t x_addr, uint8_t y_addr, Colors_t charColor, Colors_t backgroundColor){
	for(uint8_t i = 0; text[i] != '\0'; i++, x_addr+=8){
		if((x_addr+8)>Screen_t.width){
			y_addr+=9;
			x_addr=0;
		}
		ST7735_TFT_writeChar(text[i], x_addr, y_addr, charColor, backgroundColor);
	}
}

__attribute__((always_inline)) static inline void resetHW(void){
	RST_PIN(RST_PORT, RST);
	HAL_Delay(5);
	SET_PIN(RST_PORT, RST);
	HAL_Delay(200); //after max 120ms resetting cancel occurs
}

static void send_command(uint8_t cmd){
	RST_PIN(DC_PORT, DC);
	send_byte(cmd);
	SET_PIN(DC_PORT, DC);
}

static void send_byte(uint8_t byte){
	RST_PIN(CS_PORT, CS);
	HAL_SPI_Transmit(spi_ptr, &byte, 1, 1000);
	SET_PIN(CS_PORT, CS);
}

static void send_data(uint8_t buff[], uint16_t size){
	HAL_SPI_Transmit(spi_ptr, buff, size, 1000);
}

static void send_pixelVal(Colors_t color){
	uint8_t buff[2]={(color>>8), color&0xFF};
	RST_PIN(CS_PORT, CS);
	send_data(buff, 2);
	SET_PIN(CS_PORT, CS);
}




